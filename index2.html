<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cedro Aventuras - MASTER V22</title>
    <style>
        :root { --primary: #2d5a27; --danger: #e74c3c; --bg: #f4f6f8; --insta: #8e44ad; --gold: #d4af37; --dark: #2c3e50; --card-bg: #ffffff; --text: #333333; }

        /* MODO ESCURO */
        body.dark-mode { --bg: #121212; --card-bg: #1e1e1e; --text: #e0e0e0; --dark: #000000; }
        body.dark-mode .panel, body.dark-mode header, body.dark-mode .card, body.dark-mode .login-box { background: var(--card-bg); color: var(--text); }
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea { background: #333; color: white; border-color: #555; }
        body.dark-mode .timer-big { color: #fff; }
        body.dark-mode .card.paused { background: #2c2c20; border-left-color: #f1c40f; }
        body.dark-mode table th { background: #333; color: #ccc; }
        body.dark-mode table td { border-bottom: 1px solid #444; color: #ddd; }
        body.dark-mode tr:last-child td { border-bottom: none; }

        body { font-family: 'Segoe UI', Roboto, Helvetica, sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; color: var(--text); transition: background 0.3s; }

        /* Telas de Acesso */
        #login-screen, #register-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, #1e3c1a, #2d5a27); position: fixed; width: 100%; z-index: 2000; top: 0; left: 0; }
        .login-box { background: var(--card-bg); padding: 30px; border-radius: 15px; width: 320px; text-align: center; box-shadow: 0 15px 30px rgba(0,0,0,0.3); }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 15px; }

        .btn-main { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 15px; transition: 0.2s; margin-top: 10px; }
        .btn-main:active { transform: scale(0.98); }

        /* Bot√£o Cadastro Vermelho */
        .btn-register { width: 100%; padding: 12px; background: var(--danger); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 15px; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-register:hover { background: #c0392b; }

        /* App Principal */
        #app-screen { display: none; padding: 15px; max-width: 600px; margin: 0 auto; }
        header { background: var(--card-bg); padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .panel { background: var(--card-bg); padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 3px 8px rgba(0,0,0,0.08); }

        /* Painel Master */
        #master-panel { display: none; border: 2px solid var(--gold); background: #fffcf5; }
        body.dark-mode #master-panel { background: #2a2510; }
        .master-badge { background: var(--gold); color: #5a4a00; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .global-item { background: #333; color: #0f0; padding: 8px; border-radius: 5px; margin-bottom: 5px; font-family: monospace; font-size: 12px; border-left: 4px solid #0f0; }

        /* Bot√µes de Frota */
        .frota-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; }
        .btn-frota { padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 13px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative; overflow: hidden; }

        .cor-branco { background: #ffffff; color: #333; border: 2px solid #ddd; }
        .cor-vermelho { background: #c0392b; color: white; }
        .cor-amarelo { background: #f1c40f; color: #333; }
        .cor-rosa { background: #e91e63; color: white; }
        .cor-azul { background: #2980b9; color: white; }
        .cor-verde { background: #27ae60; color: white; }
        .cor-preto { background: #333; color: white; }
        .cor-laranja { background: #e67e22; color: white; }
        .cor-padrao { background: var(--primary); color: white; }

        /* Cards */
        .card { background: var(--card-bg); padding: 15px; border-radius: 15px; border-left: 8px solid var(--primary); margin-bottom: 15px; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .card.paused { background: #fffdf0; border-left-color: #f1c40f; }
        .timer-big { font-size: 48px; font-weight: 800; text-align: center; color: var(--text); margin: 5px 0; letter-spacing: -1px; }
        .card-controls { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 10px; }
        .btn-ctrl { padding: 10px 0; border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; font-size: 12px; }

        /* TABELA */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
        thead { background-color: #f0f0f0; border-bottom: 2px solid #ddd; }
        th { padding: 12px 8px; text-align: left; color: #555; font-weight: bold; text-transform: uppercase; font-size: 11px; }
        td { padding: 12px 8px; border-bottom: 1px solid #eee; color: var(--text); }
        .valor-cell { font-weight: bold; color: var(--primary); }
        .status-cell { font-size: 11px; padding: 4px 8px; border-radius: 12px; display: inline-block; cursor: pointer; }
        .st-pago { background: #d4edda; color: #155724; }
        .st-pend { background: #f8d7da; color: #721c24; }
        .total-box { background: var(--dark); color: white; padding: 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; font-size: 18px; margin-bottom: 15px; }
        .assinatura-badge { font-size: 11px; background: #e8f5e9; color: #2e7d32; padding: 4px 8px; border-radius: 20px; border: 1px solid #c8e6c9; margin-top: 4px; display: inline-block; }
        .assinatura-alert { background: #ffebee; color: #c62828; border-color: #ffcdd2; }

        /* Modais */
        #ticket-modal, #edit-user-modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:3000; justify-content:center; align-items:center; }

        /* Footer Suporte */
        .footer-support { position: fixed; bottom: 0; left: 0; width: 100%; background: #25D366; color: white; text-align: center; padding: 10px; font-weight: bold; cursor: pointer; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.2); display: flex; justify-content: center; align-items: center; gap: 10px; }

        /* IMPRESS√ÉO T√âRMICA */
        #print-area { display: none; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { display: block; position: absolute; left: 0; top: 0; width: 58mm; font-family: 'Courier New', Courier, monospace; font-size: 12px; text-align: center; color: black; padding: 0; margin: 0; }
            .print-line { border-bottom: 1px dashed #000; margin: 5px 0; }
            .print-bold { font-weight: bold; font-size: 14px; }
            .print-big { font-size: 18px; font-weight: bold; margin: 5px 0; }
        }
    </style>
</head>
<body>

<!-- √ÅREA DE IMPRESS√ÉO -->
<div id="print-area">
    <div style="text-align:center">
        -----------------------<br>
        <b class="print-bold">Brinquedos El√©tricos</b><br>
        <span id="print-cidade">CEDRO</span><br>
        -----------------------<br>
        VOC√ä ACABOU DE COMPRAR<br>
        <div class="print-big" id="print-tempo">10 MINUTOS</div>
        <div class="print-big" id="print-valor">R$ 10,00</div>
        <br>
        ---------- P A G O ----------<br>
        <br>
        Obrigado pela prefer√™ncia!<br>
        Siga-nos no instagram para<br>
        ganhar B√îNUS!!!<br>
        -----------------------<br>
        <small id="print-data">Data: 00/00/00 00:00</small>
        <br><br>.
    </div>
</div>

<!-- TELA DE LOGIN -->
<div id="login-screen">
    <div class="login-box">
        <h2 style="color: var(--primary); margin:0 0 15px 0">üå≤ Cedro Aventuras</h2>
        <select id="login-cidade">
            <option value="">Selecione sua Cidade</option>
            <option>Cedro</option><option>Varzea Alegre</option><option>Ic√≥</option><option>Iguatu</option>
            <option>Lavras da Mangabeira</option><option>Fortaleza</option>
        </select>
        <input type="text" id="user" placeholder="Usu√°rio">
        <input type="password" id="pass" placeholder="Senha">
        <button class="btn-main" onclick="window.tentarLogin()">ACESSAR SISTEMA</button>

        <button class="btn-register" onclick="window.switchScreen('register')">
            üìù SOLICITAR CADASTRO
        </button>
    </div>
</div>

<!-- TELA DE CADASTRO -->
<div id="register-screen" style="display: none;">
    <div class="login-box">
        <h3 style="margin:0 0 15px 0">üìù Novo Parceiro</h3>
        <input type="text" id="reg-nome" placeholder="Nome Completo">
        <input type="text" id="reg-user" placeholder="Nome de Usu√°rio (Login)">
        <input type="password" id="reg-pass" placeholder="Crie uma Senha">
        <select id="reg-cidade"><option>Cedro</option><option>Iguatu</option><option>Ic√≥</option><option>Varzea Alegre</option></select>
        <input type="number" id="reg-preco" placeholder="Pre√ßo do Minuto (Ex: 1.00)">
        <input type="text" id="reg-zap" placeholder="WhatsApp (DDD + N√∫mero)">
        <textarea id="reg-frota" placeholder="Ve√≠culos (Ex: Carrinho Branco, Moto Vermelha)"></textarea>
        <button class="btn-main" onclick="window.cadastrarUsuario()">ENVIAR SOLICITA√á√ÉO</button>
        <button onclick="window.switchScreen('login')" style="margin-top:15px; background:#666; border:none; color:white; padding:10px; border-radius:8px; width:100%; cursor:pointer">‚¨ÖÔ∏è VOLTAR</button>
    </div>
</div>

<!-- TELA PRINCIPAL -->
<div id="app-screen">
    <header>
        <div>
            <div id="op-nome" style="font-weight: 800; font-size:16px">Usuario</div>
            <div id="op-assinatura" class="assinatura-badge">Verificando assinatura...</div>
        </div>
        <div style="text-align:right; display:flex; align-items:center; gap:10px">
            <button onclick="window.toggleDarkMode()" style="background:transparent; border:1px solid #ccc; border-radius:50%; width:30px; height:30px; cursor:pointer; font-size:14px">üåô</button>
            <div>
                <div id="relogio" style="font-weight:bold; font-size:18px">00:00</div>
                <div id="btn-master-toggle" style="display:none; cursor:pointer; font-size:12px; color:var(--gold)" onclick="window.toggleMasterPanel()">üëë PAINEL JEDAY</div>
            </div>
        </div>
        <button onclick="location.reload()" style="margin-left:10px; border:none; background:#eee; padding:8px 12px; border-radius:6px; color:#333">Sair</button>
    </header>

    <!-- Bot√£o Vender Ticket -->
    <div class="panel" style="background: #e3f2fd; border: 1px solid #90caf9; text-align:center">
        <button onclick="window.abrirModalTicket()" style="background: #1976d2; color: white; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; font-size: 14px; width: 100%;">üéüÔ∏è VENDER TICKET AVULSO</button>
    </div>

    <div id="master-panel" class="panel">
        <h3 style="color:var(--gold); margin-top:0">üëë COMANDO GLOBAL</h3>

        <div style="margin-bottom:15px">
            <div style="font-size:12px; font-weight:bold; color:#666; margin-bottom:5px">üåç BRINQUEDOS RODANDO AGORA:</div>
            <div id="global-monitor">Carregando...</div>
        </div>
        <hr style="border:0; border-top:1px solid #ddd">
        <div style="margin-top:15px">
            <div style="font-size:12px; font-weight:bold; color:#666; margin-bottom:5px">üë• GEST√ÉO DE PARCEIROS:</div>
            <div id="lista-usuarios-master"></div>
        </div>
    </div>

    <div class="panel">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px">
            <input type="text" id="nome-crianca" placeholder="Nome da Crian√ßa">
            <input type="text" id="nome-responsavel" placeholder="Respons√°vel">
        </div>
        <div style="display:flex; gap:5px; flex-wrap:wrap; margin-bottom:15px">
            <button class="btn-ctrl" style="background:#ddd; color:#333; flex:1" onclick="window.setQuickTime(5)">5m</button>
            <button class="btn-ctrl" style="background:#ddd; color:#333; flex:1" onclick="window.setQuickTime(10)">10m</button>
            <button class="btn-ctrl" style="background:#ddd; color:#333; flex:1" onclick="window.setQuickTime(15)">15m</button>
            <button class="btn-ctrl" style="background:#ddd; color:#333; flex:1" onclick="window.setQuickTime(20)">20m</button>
            <button class="btn-ctrl" style="background:#ddd; color:#333; flex:1" onclick="window.setQuickTime(30)">30m</button>
            <button class="btn-ctrl" style="background:#2c3e50; flex:1" onclick="window.setQuickTime(9999)">LIVRE</button>
        </div>
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px">
            <span>Tempo:</span>
            <input type="number" id="tempo-padrao" value="10" style="width:60px; text-align:center; font-weight:bold">
            <span style="font-size:12px; color:#666">minutos</span>
        </div>
        <div class="frota-grid" id="frota-dinamica"></div>
    </div>

    <div id="container-cards"></div>

    <div class="panel">
        <div class="total-box">
            <span>üí∞ FATURAMENTO (PAGO)</span>
            <span id="total-valor">R$ 0,00</span>
        </div>
        <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap">
            <input type="date" id="filtro-data" style="margin:0; flex:1" onchange="window.carregarHistorico()">
            <select id="filtro-master-user" style="display:none; margin:0; flex:1" onchange="window.carregarHistorico()"></select>
            <button id="btn-limpar-hist" onclick="window.limparHistorico()" style="display:none; background:var(--danger); color:white; border:none; border-radius:6px; padding:0 15px; font-weight:bold">üóë LIMPAR</button>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Hora</th>
                        <th>Ve√≠culo</th>
                        <th style="text-align:center">Tempo</th>
                        <th style="text-align:right">Valor</th>
                        <th style="text-align:center">Status</th>
                    </tr>
                </thead>
                <tbody id="corpo-historico"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- MODAL TICKET -->
<div id="ticket-modal">
    <div class="login-box" style="width:90%; max-width:300px">
        <h3>üñ®Ô∏è Imprimir Ticket</h3>
        <input type="number" id="ticket-tempo" placeholder="Minutos" value="10">
        <input type="number" id="ticket-valor" placeholder="Valor (R$)" value="10.00">
        <button class="btn-main" onclick="window.imprimirTicketManual()">IMPRIMIR AGORA</button>
        <button onclick="document.getElementById('ticket-modal').style.display='none'" style="margin-top:10px; background:transparent; border:none; color:#333; cursor:pointer">Cancelar</button>
    </div>
</div>

<!-- MODAL EDITAR USU√ÅRIO (JEDAY) -->
<div id="edit-user-modal">
    <div class="login-box" style="width:90%; max-width:350px; text-align:left">
        <h3 style="margin:0 0 15px 0; text-align:center">‚úèÔ∏è Editar Usu√°rio</h3>
        <input type="hidden" id="edit-id">
        <label>Nome:</label><input type="text" id="edit-nome">
        <label>Usu√°rio (Login):</label><input type="text" id="edit-user">
        <label>Senha:</label><input type="text" id="edit-pass">
        <label>Pre√ßo:</label><input type="number" id="edit-preco">
        <label>WhatsApp:</label><input type="text" id="edit-zap">
        <label>Frota:</label><textarea id="edit-frota" rows="3"></textarea>

        <button class="btn-main" onclick="window.salvarEdicaoUser()">SALVAR ALTERA√á√ïES</button>
        <button onclick="document.getElementById('edit-user-modal').style.display='none'" style="margin-top:10px; width:100%; background:#ccc; border:none; padding:10px; border-radius:8px; cursor:pointer">Cancelar</button>
    </div>
</div>

<!-- FOOTER SUPORTE -->
<div class="footer-support" onclick="window.open('https://wa.me/5588981385466', '_blank')">
    <span>üõ†Ô∏è Suporte T√©cnico: Jeday Roget</span>
    <svg width="20" height="20" fill="white" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, getDocs, where, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD3WIeOM21IkcjytZ9-We7vJjOV-dYq2IA",
        authDomain: "cedro-aventuras.firebaseapp.com",
        projectId: "cedro-aventuras",
        storageBucket: "cedro-aventuras.firebasestorage.app",
        messagingSenderId: "750741113990",
        appId: "1:750741113990:web:35783abcde7f8eb6f6d507"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let USER_DATA = null;

    // --- MODO ESCURO ---
    window.toggleDarkMode = () => {
        document.body.classList.toggle('dark-mode');
    };

    // --- LOGIN ---
    window.tentarLogin = async () => {
        const cidade = document.getElementById('login-cidade').value;
        const user = document.getElementById('user').value;
        const pass = document.getElementById('pass').value;

        if(user === "Jeday" && pass === "master77") {
            loginSucesso({ 
                nome: "Jeday", usuario: "Jeday", cidade: "Cedro", status: "ativo", isMaster: true, 
                frota: "Carrinho Branco, Carrinho Vermelho, Triciclo Amarelo, Triciclo Branco, Triciclo Rosa, Patinete", 
                preco: 1, validade: 9999999999999 
            });
            return;
        }

        let q = query(collection(db, "usuarios"), where("usuario", "==", user), where("cidade", "==", cidade));
        let snap = await getDocs(q);

        if(snap.empty) {
            q = query(collection(db, "usuarios"), where("nome", "==", user), where("cidade", "==", cidade));
            snap = await getDocs(q);
        }

        if(snap.empty || snap.docs[0].data().pass !== pass) return alert("Dados incorretos.");

        const dados = snap.docs[0].data();
        if(dados.status !== "ativo") return alert("Aguarde a aprova√ß√£o do Jeday.");

        const agora = Date.now();
        if(dados.validade && agora > dados.validade) {
            return alert("SUA ASSINATURA EXPIROU! Entre em contato com Jeday para renovar.");
        }

        loginSucesso({...dados, id: snap.docs[0].id});
    };

    function loginSucesso(dados) {
        USER_DATA = dados;
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-screen').style.display = 'block';
        document.getElementById('op-nome').innerText = USER_DATA.nome;

        const agora = Date.now();
        if(USER_DATA.isMaster) {
            document.getElementById('op-assinatura').innerText = "üëë Acesso Vital√≠cio";
        } else {
            const diasRestantes = Math.ceil((USER_DATA.validade - agora) / (1000 * 60 * 60 * 24));
            const elAss = document.getElementById('op-assinatura');
            elAss.innerText = `‚è≥ ${diasRestantes} dias restantes`;
            if(diasRestantes <= 3) elAss.classList.add('assinatura-alert');
        }

        if(USER_DATA.isMaster) {
            document.getElementById('btn-master-toggle').style.display = 'block';
            document.getElementById('filtro-master-user').style.display = 'block';
            document.getElementById('btn-limpar-hist').style.display = 'block';
            iniciarMasterListeners();
        }

        montarFrota();
        iniciarCards();
        window.carregarHistorico();
    }

    // --- RENDERIZA√á√ÉO DA FROTA ---
    function montarFrota() {
        const div = document.getElementById('frota-dinamica');
        div.innerHTML = "";
        USER_DATA.frota.split(',').forEach(item => {
            const nome = item.trim();
            const corClass = descobrirCor(nome);
            div.innerHTML += `<button class="btn-frota ${corClass}" onclick="window.iniciar('${nome}')">${nome}</button>`;
        });
    }

    function descobrirCor(texto) {
        const t = texto.toLowerCase();
        if(t.includes('vermelh')) return 'cor-vermelho';
        if(t.includes('branc')) return 'cor-branco';
        if(t.includes('amarel')) return 'cor-amarelo';
        if(t.includes('rosa')) return 'cor-rosa';
        if(t.includes('azul')) return 'cor-azul';
        if(t.includes('verd')) return 'cor-verde';
        if(t.includes('pret')) return 'cor-preto';
        if(t.includes('laranj')) return 'cor-laranja';
        return 'cor-padrao';
    }

    // --- L√ìGICA DE CARDS ---
    window.iniciar = async (veiculo) => {
        const min = parseInt(document.getElementById('tempo-padrao').value);
        const agora = Date.now();

        await addDoc(collection(db, `ativos_${USER_DATA.nome}_${USER_DATA.cidade}`), {
            veiculo, crianca: document.getElementById('nome-crianca').value || "Cliente",
            timestamp: agora, fimTimestamp: agora + (min * 60000),
            minutosContratados: min, pago: "N√£o", pausado: false, 
            msRestantes: min * 60000, totalMsPausado: 0, precoBase: USER_DATA.preco, modalidadeLivre: min >= 9999
        });
        document.getElementById('nome-crianca').value = "";
    };

    function iniciarCards() {
        onSnapshot(collection(db, `ativos_${USER_DATA.nome}_${USER_DATA.cidade}`), (snap) => {
            const div = document.getElementById('container-cards');
            const ativos = snap.docs.map(d => d.id);
            document.querySelectorAll('.card').forEach(c => { if(!ativos.includes(c.id.replace('c-',''))) c.remove(); });

            snap.docs.forEach(docSnap => {
                const d = docSnap.data(), id = docSnap.id;
                let el = document.getElementById(`c-${id}`);

                if(!el) {
                    div.insertAdjacentHTML('beforeend', `
                        <div class="card" id="c-${id}">
                            <div style="display:flex; justify-content:space-between">
                                <div><b>${d.veiculo}</b><br><small>${d.crianca}</small></div>
                                <button id="pg-${id}" onclick="window.pg('${id}')" style="border:none; border-radius:5px; font-weight:bold; cursor:pointer; height:30px"></button>
                            </div>
                            <div class="timer-big" id="t-${id}">00:00</div>
                            <div class="card-controls">
                                <button class="btn-ctrl" style="background:#e67e22" onclick="window.add('${id}',-1)">-1m</button>
                                <button class="btn-ctrl" style="background:#27ae60" onclick="window.add('${id}',1)">+1m</button>
                                <button class="btn-ctrl" style="background:var(--insta)" onclick="window.addBonus('${id}')">üéÅ 20%</button>
                                <button class="btn-ctrl" style="background:#2980b9" id="ps-${id}" onclick="window.ps('${id}')">‚è∏</button>
                                <button class="btn-ctrl" style="background:#c0392b" onclick="window.fim('${id}')">FIM</button>
                            </div>
                        </div>
                    `);
                    el = document.getElementById(`c-${id}`);
                }

                const btnPg = document.getElementById(`pg-${id}`);
                btnPg.innerText = d.pago === 'Sim' ? '‚úÖ PAGO' : 'PENDENTE';
                btnPg.style.background = d.pago === 'Sim' ? '#d4edda' : '#f8d7da';
                btnPg.style.color = d.pago === 'Sim' ? '#155724' : '#721c24';

                document.getElementById(`ps-${id}`).innerText = d.pausado ? '‚ñ∂' : '‚è∏';
                el.classList.toggle('paused', d.pausado);

                if(window[`tm-${id}`]) clearInterval(window[`tm-${id}`]);
                window[`tm-${id}`] = setInterval(() => {
                    let rest = d.pausado ? d.msRestantes : (d.modalidadeLivre ? (Date.now() - d.timestamp - d.totalMsPausado) : (d.fimTimestamp - Date.now()));
                    if(!d.modalidadeLivre) rest = Math.max(0, rest);
                    const s = Math.floor(rest/1000);
                    document.getElementById(`t-${id}`).innerText = `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
                }, 1000);
            });
        });
    }

    // --- CONTROLES ---
    window.add = async(id, m) => {
        const r = doc(db, `ativos_${USER_DATA.nome}_${USER_DATA.cidade}`, id), d = (await getDoc(r)).data();
        await updateDoc(r, d.pausado ? { msRestantes: d.msRestantes + (m*60000) } : { fimTimestamp: d.fimTimestamp + (m*60000) });
    };

    // B√îNUS INSTAGRAM
    window.addBonus = async(id) => {
        const r = doc(db, `ativos_${USER_DATA.nome}_${USER_DATA.cidade}`, id), d = (await getDoc(r)).data();
        if(d.modalidadeLivre) return alert("Modo Livre n√£o tem limite de tempo.");

        const bonusMin = Math.floor(d.minutosContratados * 0.20); // 20%
        if(bonusMin < 1) return alert("Tempo muito curto para b√¥nus.");

        if(confirm(`Adicionar b√¥nus de ${bonusMin} minutos (Instagram)?\nO valor cobrado n√£o mudar√°.`)) {
            await updateDoc(r, d.pausado ? { msRestantes: d.msRestantes + (bonusMin*60000) } : { fimTimestamp: d.fimTimestamp + (bonusMin*60000) });
        }
    };

    window.ps = async(id) => {
        const r = doc(db, `ativos_${USER_DATA.nome}_${USER_DATA.cidade}`, id), d = (await getDoc(r)).data(), now = Date.now();
        if(d.pausado) await updateDoc(r, { pausado: false, fimTimestamp: now + d.msRestantes, totalMsPausado: (d.totalMsPausado||0) + (now - d.ultimoPause) });
        else await updateDoc(r, { pausado: true, msRestantes: d.fimTimestamp - now, ultimoPause: now });
    };

    window.pg = async(id) => {
        const r = doc(db, `ativos_${USER_DATA.nome}_${USER_DATA.cidade}`, id), d = (await getDoc(r)).data();
        await updateDoc(r, { pago: d.pago==='Sim'?'N√£o':'Sim' });
    };

    window.fim = async(id) => {
        if(!confirm("Finalizar?")) return;
        const r = doc(db, `ativos_${USER_DATA.nome}_${USER_DATA.cidade}`, id), d = (await getDoc(r)).data(), now = Date.now();

        const tempoDecorridoMs = now - d.timestamp - (d.totalMsPausado || 0);
        let minsReais = Math.max(1, Math.floor(tempoDecorridoMs / 60000));

        let minsCobrar = minsReais;
        if(!d.modalidadeLivre) {
            minsCobrar = Math.min(minsReais, d.minutosContratados);
        }

        const val = minsCobrar * d.precoBase;

        await addDoc(collection(db, `hist_${USER_DATA.nome}_${USER_DATA.cidade}`), {
            veiculo: d.veiculo, valor: val, pago: d.pago, data: now, tempo: minsCobrar
        });
        await deleteDoc(r);
    };

    // --- RELAT√ìRIO ---
    window.carregarHistorico = async () => {
        const userRef = document.getElementById('filtro-master-user').value;
        const colName = (USER_DATA.isMaster && userRef && userRef !== 'meu') ? `hist_${userRef}` : `hist_${USER_DATA.nome}_${USER_DATA.cidade}`;
        const dataF = document.getElementById('filtro-data').value;

        onSnapshot(query(collection(db, colName), orderBy('data', 'desc')), (snap) => {
            const tb = document.getElementById('corpo-historico');
            let total = 0; tb.innerHTML = "";
            snap.forEach(d => {
                const h = d.data();
                const dia = new Date(h.data).toISOString().split('T')[0];
                if(!dataF || dataF === dia) {
                    if(h.pago === 'Sim') total += h.valor;

                    const hora = new Date(h.data).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    tb.innerHTML += `
                        <tr>
                            <td>${hora}</td>
                            <td>${h.veiculo}</td>
                            <td style="text-align:center">${h.tempo}m</td>
                            <td class="valor-cell" style="text-align:right">R$ ${h.valor.toFixed(2)}</td>
                            <td style="text-align:center">
                                <span class="status-cell ${h.pago==='Sim'?'st-pago':'st-pend'}" onclick="window.toggleHistPg('${d.id}', '${colName}', '${h.pago}')">${h.pago}</span>
                            </td>
                        </tr>
                    `;
                }
            });
            document.getElementById('total-valor').innerText = `R$ ${total.toFixed(2)}`;
        });
    };

    window.toggleHistPg = async (docId, colName, statusAtual) => {
        const novoStatus = statusAtual === 'Sim' ? 'N√£o' : 'Sim';
        await updateDoc(doc(db, colName, docId), { pago: novoStatus });
    };

    window.limparHistorico = async () => {
        if(!USER_DATA.isMaster) return;
        if(!confirm("‚ö†Ô∏è ATEN√á√ÉO JEDAY!\nIsso vai apagar TODO o hist√≥rico exibido na tabela.\nTem certeza?")) return;
        const userRef = document.getElementById('filtro-master-user').value;
        const colName = (userRef && userRef !== 'meu') ? `hist_${userRef}` : `hist_${USER_DATA.nome}_${USER_DATA.cidade}`;
        const q = query(collection(db, colName));
        const snap = await getDocs(q);
        const batch = writeBatch(db);
        snap.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        alert("Hist√≥rico limpo com sucesso!");
    };

    // --- TICKET ---
    window.abrirModalTicket = () => {
        document.getElementById('ticket-modal').style.display = 'flex';
    };

    window.imprimirTicketManual = () => {
        const min = document.getElementById('ticket-tempo').value;
        const val = parseFloat(document.getElementById('ticket-valor').value).toFixed(2);

        document.getElementById('print-cidade').innerText = USER_DATA.cidade.toUpperCase();
        document.getElementById('print-tempo').innerText = `${min} MINUTOS`;
        document.getElementById('print-valor').innerText = `R$ ${val}`;
        document.getElementById('print-data').innerText = `Data: ${new Date().toLocaleString()}`;

        window.print();
        document.getElementById('ticket-modal').style.display = 'none';
    };

    // --- MASTER ---
    function iniciarMasterListeners() {
        onSnapshot(collection(db, "usuarios"), (snap) => {
            const lst = document.getElementById('lista-usuarios-master');
            const sel = document.getElementById('filtro-master-user');
            lst.innerHTML = ""; sel.innerHTML = "<option value='meu'>Meu Caixa</option>";

            snap.forEach(d => {
                const u = d.data();
                sel.innerHTML += `<option value="${u.nome}_${u.cidade}">${u.cidade} - ${u.nome}</option>`;

                onSnapshot(collection(db, `ativos_${u.nome}_${u.cidade}`), (sA) => {
                    const mon = document.getElementById('global-monitor');
                    const divId = `gm-${d.id}`;
                    let b = document.getElementById(divId);
                    if(!b) { mon.insertAdjacentHTML('beforeend', `<div id="${divId}"></div>`); b=document.getElementById(divId); }
                    b.innerHTML = "";
                    sA.forEach(a => {
                        b.innerHTML += `<div class="global-item">üìç ${u.cidade} | ${a.data().veiculo}</div>`;
                    });
                });

                const diasRest = u.validade ? Math.ceil((u.validade - Date.now()) / (86400000)) : 0;
                const statusColor = u.status === 'ativo' ? 'green' : 'red';

                // Bot√£o de Editar (L√°pis)
                lst.innerHTML += `
                <div style="background:#eee; padding:10px; margin-bottom:8px; border-radius:8px; border-left:4px solid ${statusColor}">
                    <div style="display:flex; justify-content:space-between; align-items:center">
                        <div>
                            <b>${u.nome}</b> (${u.cidade})<br>
                            <small>User: ${u.usuario || 'Antigo'}</small><br>
                            <small>Status: <b>${u.status.toUpperCase()}</b></small>
                        </div>
                        <div style="display:flex; gap:5px">
                            <button onclick="window.editarUser('${d.id}')" style="background:#333; color:white; border:none; border-radius:4px; padding:5px; cursor:pointer">‚úèÔ∏è</button>
                            <button onclick="window.delUser('${d.id}')" style="background:red; color:white; border:none; border-radius:4px; padding:5px; cursor:pointer">X</button>
                        </div>
                    </div>
                    <div style="margin-top:8px; display:flex; gap:5px; align-items:center; background:white; padding:5px; border-radius:5px">
                        <small>Assinatura: <b>${diasRest} dias</b></small>
                        <input type="number" id="add-dias-${d.id}" placeholder="+Dias" style="width:60px; margin:0; padding:5px">
                        <button onclick="window.renovarUser('${d.id}')" style="background:var(--gold); border:none; padding:5px 10px; border-radius:4px; font-weight:bold; cursor:pointer">RENOVAR</button>
                    </div>
                    ${u.status !== 'ativo' ? `<button onclick="window.ativarUser('${d.id}')" style="width:100%; margin-top:5px; background:var(--primary); color:white; border:none; padding:5px; border-radius:4px">APROVAR CADASTRO</button>` : ''}
                </div>`;
            });
        });
    }

    // --- FUN√á√ïES DE EDI√á√ÉO JEDAY ---
    window.editarUser = async (id) => {
        const docSnap = await getDoc(doc(db, "usuarios", id));
        const u = docSnap.data();
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-nome').value = u.nome;
        document.getElementById('edit-user').value = u.usuario || "";
        document.getElementById('edit-pass').value = u.pass;
        document.getElementById('edit-preco').value = u.preco;
        document.getElementById('edit-zap').value = u.whatsapp || "";
        document.getElementById('edit-frota').value = u.frota;
        document.getElementById('edit-user-modal').style.display = 'flex';
    };

    window.salvarEdicaoUser = async () => {
        const id = document.getElementById('edit-id').value;
        await updateDoc(doc(db, "usuarios", id), {
            nome: document.getElementById('edit-nome').value,
            usuario: document.getElementById('edit-user').value,
            pass: document.getElementById('edit-pass').value,
            preco: parseFloat(document.getElementById('edit-preco').value),
            whatsapp: document.getElementById('edit-zap').value,
            frota: document.getElementById('edit-frota').value
        });
        document.getElementById('edit-user-modal').style.display = 'none';
        alert("Dados atualizados com sucesso!");
    };

    // Fun√ß√£o oculta para criar usu√°rios padr√£o (Senha 1234)
    window.criarUsuariosPadrao = async () => {
        if(!confirm("Criar Cydinha e Thallys em Cedro?")) return;
        const batch = writeBatch(db);

        const ref1 = doc(collection(db, "usuarios"));
        batch.set(ref1, {
            nome: "Cydinha", usuario: "Cydinha", pass: "1234", cidade: "Cedro", preco: 1.0, 
            whatsapp: "", frota: "Carrinho Rosa, Moto Branca", status: "ativo", validade: Date.now() + (365*24*60*60*1000)
        });

        const ref2 = doc(collection(db, "usuarios"));
        batch.set(ref2, {
            nome: "Thallys", usuario: "Thallys", pass: "1234", cidade: "Cedro", preco: 1.0, 
            whatsapp: "", frota: "Carrinho Azul, Moto Preta", status: "ativo", validade: Date.now() + (365*24*60*60*1000)
        });

        await batch.commit();
        alert("Usu√°rios criados!");
    };

    window.delUser = async(id) => { if(confirm("Remover usu√°rio?")) await deleteDoc(doc(db, "usuarios", id)); };
    window.renovarUser = async(id) => {
        const dias = parseInt(document.getElementById(`add-dias-${id}`).value);
        if(!dias) return alert("Digite a quantidade de dias");
        const novaValidade = Date.now() + (dias * 24 * 60 * 60 * 1000);
        await updateDoc(doc(db, "usuarios", id), { validade: novaValidade, status: 'ativo' });
        alert("Assinatura renovada!");
    };
    window.ativarUser = async(id) => {
        if(confirm("Aprovar este usu√°rio?")) {
            await updateDoc(doc(db, "usuarios", id), { status: 'ativo', validade: Date.now() + 86400000 }); 
        }
    };

    window.setQuickTime = (v) => document.getElementById('tempo-padrao').value = v;
    window.toggleMasterPanel = () => { const p=document.getElementById('master-panel'); p.style.display = p.style.display==='block'?'none':'block'; };
    window.switchScreen = (s) => { document.getElementById('login-screen').style.display = s==='login'?'flex':'none'; document.getElementById('register-screen').style.display = s==='register'?'flex':'none'; };

    window.cadastrarUsuario = async () => {
        const nome = document.getElementById('reg-nome').value;
        const user = document.getElementById('reg-user').value;
        const pass = document.getElementById('reg-pass').value;
        const cidade = document.getElementById('reg-cidade').value;
        const preco = parseFloat(document.getElementById('reg-preco').value);
        const zap = document.getElementById('reg-zap').value;
        const frota = document.getElementById('reg-frota').value;

        if(!nome || !user || !pass || !preco || !frota) return alert("Preencha tudo!");

        await addDoc(collection(db,"usuarios"), {
            nome, usuario: user, pass, cidade, preco, whatsapp: zap, frota, 
            status: 'pendente', validade: 0 
        }); 
        alert("Solicita√ß√£o enviada! Aguarde aprova√ß√£o do Jeday."); 
        window.switchScreen('login');
    };

    setInterval(() => document.getElementById('relogio').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), 1000);
</script>
</body>

